<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geofencing with Compass</title>

</head>
<body>

<div id="message"></div>

<script>
  // Geofence coordinates
  const centerLatitude = 39.098055689582345;
  const centerLongitude = -94.56668448927029;
  const fenceRadius = 1; // in meters
  const numCheckpoints = 5;
  const checkpointOffset = 0.0001; // Offset to place checkpoints slightly away from each other
  
  // Checkpoint coordinates
  const checkpoints = [
    { latitude: centerLatitude, longitude: centerLongitude + (checkpointOffset * 3) },
    { latitude: centerLatitude, longitude: centerLongitude },
    { latitude: centerLatitude, longitude: centerLongitude + (checkpointOffset * 2) },
    { latitude: centerLatitude, longitude: centerLongitude - (checkpointOffset * 2) },
    { latitude: centerLatitude, longitude: centerLongitude - (checkpointOffset * 3) }
  ];



  // Message element
  const message = document.getElementById('message');

  // Function to calculate distance between two points (in meters)
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Radius of the Earth in meters
    const φ1 = lat1 * Math.PI / 180; // φ, λ in radians
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2-lat1) * Math.PI / 180;
    const Δλ = (lon2-lon1) * Math.PI / 180;

    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    const d = R * c; // Distance in meters
    return d;
  }



  // Function to check if the user is near a checkpoint
  function checkCheckpoints(latitude, longitude) {
    for (let i = 0; i < numCheckpoints; i++) {
      const distance = calculateDistance(latitude, longitude, checkpoints[i].latitude, checkpoints[i].longitude);
      if (distance < fenceRadius) {
        message.textContent = `You are close to checkpoint ${i + 1}`;
        return i; // Return the index of the checkpoint
      }
    }
    return -1; // No checkpoint nearby
  }

  // Function to update user location and check checkpoints
  function updateUserLocation(position) {
    const latitude = position.coords.latitude;
    const longitude = position.coords.longitude;
    const checkpointIndex = checkCheckpoints(latitude, longitude);
    if (checkpointIndex !== -1) {
      message.textContent = `Captured checkpoint ${checkpointIndex + 1}`;
    }
    const allCaptured = [...Array(numCheckpoints).keys()].every(index => calculateDistance(latitude, longitude, checkpoints[index].latitude, checkpoints[index].longitude) < fenceRadius);
    if (allCaptured) {
      message.textContent = "You win!";
    }
  }

  // Function to handle location error
  function locationError(error) {
    console.log('Error getting location:', error);
  }

  // Get user's current location
  navigator.geolocation.watchPosition(updateUserLocation, locationError);

</script>

</body>
</html>
